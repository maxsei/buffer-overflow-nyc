#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

/*
 * a toy program for learning stack buffer
 * overflow exploiting
 * It reads a list of hex data from the
 * specified file, and performs bubble sorting
 */

 /* Change this 1 to a 0 and recompile if you do not want the function to sort
  * your values. */
#define SORT 1

/* What these Variables Mean
 * `n` = line_stack ( increments on reads )
 * `c` = first iterator in sort algo
 * `d` = second iterator in sort algo
 * `v` = an effectively useless copy of `c`?
 * */
long n = 0, c = 0, d = 0, v = 0;

/* File pointer is set inside `main` */
FILE *fp = NULL;

void Sort() {
  /* Used only when sorting as a placeholder */
  long swap = 0;
  /* Array data is read into */
  long array[5];

  // loading data to array
  printf("Source list:\n");
  // A single line is the size of a long long in memory + 1 for a \x00
  char line[sizeof(long) * 2 + 1] = {0};
  /* While we still have lines to read we're going to read lines the size of the
   * line which checks out to be 17 bytes (size of lone is 8, 8 * 2 + 1 = 17).
   * However there is only only a pointer 8 bytes plus 5 * sizeof(long) = 40
   * allocated for `array`. This means reading in greater than 5 lines will
   * cause undefind behavior e.g. accessing past what is allocated for `array`
   * */
  while (fgets(line, sizeof(line), fp)) {
    /* If the line is not just a \x00 read it using sscanf */
    if (strlen((char *)line) > 1) {
      /* Use `sscanf` scans a single line and parses as `long` into `array` */
      sscanf(line, "%lx", &(array[n]));
      /* We printf hex value at `n` in `array` showing we read data */
      printf("0x%lx\n", array[n]);
      ++n;
    }
  }
  /* Always close files, resources are important yo */
  fclose(fp);

#if SORT
  for (c = 0; c < (n - 1); c++) {
    v = c;
    for (d = (c + 1); d < n; d++) {
      if (array[d] < array[v]) {
        // Swap the found minimum element with the first element
        swap = array[d];
        array[d] = array[v];
        array[v] = swap;
      }
    }
  }
#endif

  // output sorting result
  printf("\nSorted list in ascending order:\n");
  for (c = 0; c < n; c++)
    printf("%lx\n", array[c]);
}

int main(int argc, char **argv) {
  if (argc != 2) {
    printf("Usage: ./sort file_name\n");
    return -1;
  }

  // From http://stackoverflow.com/questions/5141960/get-the-current-time-in-c
  time_t rawtime;
  struct tm *timeinfo;

  time(&rawtime);
  timeinfo = localtime(&rawtime);
  printf("Current local time and date: %s\n\n", asctime(timeinfo));

  fp = fopen(argv[1], "rb");
  Sort();

  return 0;
}
